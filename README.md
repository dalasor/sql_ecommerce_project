# üìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö E-commerce —Å–µ—Ä–≤–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ SQL

[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-13+-blue?logo=postgresql)](https://www.postgresql.org/)
[![Power BI](https://img.shields.io/badge/Power_BI-F2C811?logo=powerbi)](https://powerbi.microsoft.com/)
[![Redash](https://redash.io/assets/images/elements/redash-logo.svg)](https://redash.io/)

–ü—Ä–æ–µ–∫—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º —Å –ø–æ–º–æ—â—å—é SQL –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

## üéØ –¶–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞
1. –ü—Ä–æ–≤–µ—Å—Ç–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö (EDA) –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –æ–±—â–∏—Ö –∫–ª—é—á–µ–≤—ã—Ö –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–µ–π –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –±–∏–∑–Ω–µ—Å-–ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π

2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞—Å—á–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫:
   - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (CR)
   - DAU, WAU, MAU
   - –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (AOV)
   - Retention Rate
   - LTV –∏ CAC (–≥–¥–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ)

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –≥–∏–ø–æ—Ç–µ–∑—ã:
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏
   - –û—Ü–µ–Ω–∫–∞ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–∏–π (t-—Ç–µ—Å—Ç –∏ p-value)
   
4. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞–≤—ã–∫–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è SELECT-–∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞–∑–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å  –∏–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–π (joins), –ø–æ–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ CTE –∏ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π. –¢–∞–∫–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. 

## –°–¥–µ—Ä–∂–∞–Ω–∏–µ
- [üìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö E-commerce —Å–µ—Ä–≤–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –Ω–∞ SQL](#-–∞–Ω–∞–ª–∏–∑-–¥–∞–Ω–Ω—ã—Ö-e-commerce-—Å–µ—Ä–≤–∏—Å–∞-–¥–æ—Å—Ç–∞–≤–∫–∏-–Ω–∞-sql)
  * [üéØ –¶–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞](#-—Ü–µ–ª–∏-–ø—Ä–æ–µ–∫—Ç–∞)
  * [üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫](#-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π-—Å—Ç–µ–∫)
  * [üìÅ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ç–∞—Å–µ—Ç–∞](#-–æ–ø–∏—Å–∞–Ω–∏–µ-–¥–∞—Ç–∞—Å–µ—Ç–∞)
  * [üöÄ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ](#-–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ)
    + [1. –ê–Ω–∞–ª–∏–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏](#1-–∞–Ω–∞–ª–∏–∑-—Å—Ä–µ–¥–Ω–µ–≥–æ-–≤—Ä–µ–º–µ–Ω–∏-–¥–æ—Å—Ç–∞–≤–∫–∏)
    + [2. –ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∏—Ö –ø—Ä–æ–¥–∞–∂](#2-–∞–Ω–∞–ª–∏–∑-—Ç–æ–≤–∞—Ä–æ–≤-–∏-–∏—Ö-–ø—Ä–æ–¥–∞–∂)
      - [1. –í—ã—Ä—É—á–∫–∞](#1-–≤—ã—Ä—É—á–∫–∞)
      - [2. –ö–∞–∫–∏–µ –ø–∞—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–∫—É–ø–∞—é—Ç —á–∞—â–µ –≤—Å–µ–≥–æ (SELF JOIN)](#2-–∫–∞–∫–∏–µ-–ø–∞—Ä—ã-—Ç–æ–≤–∞—Ä–æ–≤-–ø–æ–∫—É–ø–∞—é—Ç-—á–∞—â–µ-–≤—Å–µ–≥–æ-self-join)
    + [3. –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π](#3-–∞–Ω–∞–ª–∏–∑-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
      - [1. –í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã](#1-–≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ-–≥—Ä—É–ø–ø—ã)
      - [2. C—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∑–∞–∫–∞–∑–∞ –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º –∏ –±—É–¥–Ω—è–º](#2-—Å—Ä–µ–¥–Ω–∏–π-—Ä–∞–∑–º–µ—Ä-–∑–∞–∫–∞–∑–∞-–ø–æ-–≤—ã—Ö–æ–¥–Ω—ã–º-–∏-–±—É–¥–Ω—è–º)
      - [3. –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏.](#3-–æ–±—â–µ–µ-–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ-–æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö-–∏-–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö-–∑–∞–∫–∞–∑–æ–≤-–ø–æ-–¥–Ω—è–º-–Ω–µ–¥–µ–ª–∏)
      - [4. –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (–ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –ø–æ –∑–∞–∫–∞–∑–∞–º)](#4-—Å—Ä–µ–¥–Ω–∏–π-—á–µ–∫-(–ø–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º-–∏-–ø–æ-–∑–∞–∫–∞–∑–∞–º))
      - [5. –ö—Ç–æ –æ—Ñ–æ—Ä–º–ª—è–ª –∏ –¥–æ—Å—Ç–∞–≤–ª—è–ª —Å–∞–º—ã–µ –±–æ–ª—å—à–∏–µ –∑–∞–∫–∞–∑—ã](#5-–∫—Ç–æ-–æ—Ñ–æ—Ä–º–ª—è–ª-–∏-–¥–æ—Å—Ç–∞–≤–ª—è–ª-—Å–∞–º—ã–µ-–±–æ–ª—å—à–∏–µ-–∑–∞–∫–∞–∑—ã)
    + [4. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –±–∏–∑–Ω–µ—Å-–ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π](#4-–≤—Ä–µ–º–µ–Ω–Ω—ã–µ-—Ç—Ä–µ–Ω–¥—ã-–±–∏–∑–Ω–µ—Å-–ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π)


## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
| –ö–∞—Ç–µ–≥–æ—Ä–∏—è       | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã                          |
|-----------------|--------------------------------------|
| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö     | PostgreSQL 16                        |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞       | SELECT-–∑–∞–ø—Ä–æ—Å—ã, CTE, –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏    |
| –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è    | Redash (—ç–∫—Å–ø—Ä–µ—Å—Å-–∞–Ω–∞–ª–∏–∑), Power BI (—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥—ã) |
| –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ   | Python (Jupyter Notebook) –¥–ª—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö |

## üìÅ –û–ø–∏—Å–∞–Ω–∏–µ –¥–∞—Ç–∞—Å–µ—Ç–∞
–î–∞–Ω–Ω—ã–µ –æ—Ç —É—á–µ–±–Ω–æ–≥–æ E-commerce —Å–µ—Ä–≤–∏—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤. 
__–°–æ—Å—Ç–∞–≤ –¥–∞–Ω–Ω—ã—Ö__:

| –¢–∞–±–ª–∏—Ü–∞           | –û–ø–∏—Å–∞–Ω–∏–µ                                 |  –ü–æ–ª—è                |
|-------------------|-----------------------------------------|------------------------------|
| `orders`          | –ó–∞–∫–∞–∑—ã                                  | order_id, creation_time, product_ids |
| `users`           | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏                            | user_id, sex, birth_date |
| `couriers`           | –ö—É—Ä—å–µ—Ä—ã                            | courier_id, sex, birth_date |
| `products`        | –¢–æ–≤–∞—Ä–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥                        | product_id, name, price |
| `courier_actions`      | –î–µ–π—Å—Ç–≤–∏—è –∫—É—Ä—å–µ—Ä–æ–≤                         | order_id, courier_id, action, time |
| `user_actions`    | –î–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π                  | order_id, user_id, action, time|

__ER-–¥–∏–æ–≥—Ä–∞–º–º–∞__:

![ER-–¥–∏–∞–≥—Ä–∞–º–º–∞](data/data_model/db_scheme.png)


–û–±—â–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –≤–∑—è—Ç –∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤  [–°–∏–º—É–ª—è—Ç–æ—Ä–∞ SQL](https://karpov.courses/simulator-sql?_gl=1*rssps2*_ga*MjExOTE4NjQ3OS4xNzM5ODMwMzAy*_ga_DZP7KEXCQQ*MTc0MjY2MTMzOS4xMzMuMS4xNzQyNjYxMzc1LjI0LjAuMA..).

## üöÄ –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
### 1. –ê–Ω–∞–ª–∏–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏
> __–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏__: –í—ã—á–∏—Å–ª–∏—Ç—å —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –¥–≤—É—Ö –≥—Ä—É–ø–ø –∑–∞–∫–∞–∑–æ–≤ --- "–±–æ–ª—å—à–∏—Ö" –∏ "–º–∞–ª—ã—Ö" --- –∏ —Å—Ä–∞–≤–Ω–∏—Ç—å –∏—Ö, –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º–æ–π.

- –°–ø–µ—Ä–≤–∞ —É–∑–Ω–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤, –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –±—É–¥–µ—Ç –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∞–∫–∏—Ö –∑–∞–∫–∞–∑–æ–≤:
```sql
with u2 AS (
    SELECT COUNT(DISTINCT order_id) AS all_orders
    FROM user_actions
)

SELECT  COUNT(u1.order_id) AS uncancelled_orders, 
        (SELECT * FROM u2) -  COUNT(u1.order_id) AS cancelled_orders,
        (SELECT * FROM u2),
        COUNT(u1.order_id)::NUMERIC / (SELECT * FROM u2) * 100 AS percantage_of_uncancelled
FROM user_actions u1
WHERE order_id NOT IN (
    SELECT order_id FROM user_actions
    WHERE action = 'cancel_order'
)
```
| uncancelled_orders | cancelled_orders | all_orders | percantage_of_uncancelled |
|--------------------|------------------|------------|---------------------------|
| 56616              | 2979             | 59595      | 95.00125849484017         |

- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏ –º–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–∞—Ö** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –≤—ã–±—Ä–æ—Å—ã:
```sql
SELECT  MIN(array_length(product_ids, 1)) AS min_order_size,
        MAX(array_length(product_ids, 1)) AS max_order_size
FROM orders
WHERE order_id NOT IN (
    SELECT order_id FROM user_actions
    WHERE action = 'cancel_order'
)
```
| min_order_size | max_order_size |  
|--------------------|------------|
|              1 | 9 

- **–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤**: –¢–µ–ø–µ—Ä—å –ø–æ–π–º–µ–º, –∫–∞–∫–∏–µ –∑–∞–∫–∞–∑—ã —Å—á–∏—Ç–∞—Ç—å "–±–æ–ª—å—à–∏–º–∏" –∏ "–º–∞–ª—ã–º–∏". –ü–æ—Å—Ç—Ä–æ–∏–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–∞—Ö. –ù–∞–π–¥–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏, –∏ –≤—ã–±–µ—Ä–µ–º –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–æ—Ä–æ–≥–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –∑–∞–∫–∞–∑–æ–≤ 75%-–∫–≤–∞—Ä—Ç–∏–ª—å:
```sql
with count_goods AS (
    SELECT  order_id, 
            array_length(product_ids, 1) AS order_size,
            MAX(array_length(product_ids, 1)) OVER() AS max_order_size,
            MIN(array_length(product_ids, 1)) OVER() AS min_order_size
    FROM orders
    WHERE order_id NOT IN (
        SELECT order_id FROM user_actions
        WHERE action = 'cancel_order'
    )
    ORDER BY order_id
    
), stats AS (
    SELECT  PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY order_size) AS percentile,
            ROUND(AVG(order_size), 2) AS avg_order_size
    FROM count_goods
)


SELECT  order_size,
        COUNT(order_id) AS count_orders,
        ROUND(COUNT(order_id) / SUM(COUNT(order_id)) OVER() * 100, 2) AS quantity_percent,
        SUM(COUNT(order_id)) OVER() AS all_orders,
        (SELECT percentile FROM stats) AS perc_75,
        (SELECT avg_order_size FROM stats) AS avg_order_size
FROM count_goods
GROUP BY order_size
ORDER BY order_size ASC
```
| order_size | count_orders | quantity_percent | all_orders | perc_75 | avg_order_size |
|------------|--------------|------------------|------------|---------|----------------|
| 1          | 3156         | 5.57             | 56616      | 4.0     | 3.4            |
| 2          | 11255        | 19.88            | 56616      | 4.0     | 3.4            |
| 3          | 16956        | 29.95            | 56616      | 4.0     | 3.4            |
| 4          | 14323        | 25.3             | 56616      | 4.0     | 3.4            |
| 5          | 7665         | 13.54            | 56616      | 4.0     | 3.4            |
| 6          | 2632         | 4.65             | 56616      | 4.0     | 3.4            |
| 7          | 556          | 0.98             | 56616      | 4.0     | 3.4            |
| 8          | 68           | 0.12             | 56616      | 4.0     | 3.4            |
| 9          | 5            | 0.01             | 56616      | 4.0     | 3.4            |

![–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ —Ä–∞–∑–º–µ—Ä—É –∑–∞–∫–∞–∑–∞](visuals/quantity_of_goods.png)
–ö–∞–∫ –≤–∏–¥–∏–º, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–ª—å—à–∏—Ö –∑–∞–∫–∞–∑–æ–≤ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —á—É—Ç—å –º–µ–Ω–µ–µ 20% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞ –∑–∞–∫–∞–∑–æ–≤.
- –†–∞—Å—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –ø–æ–º–µ—Ç–∏–º –∑–∞–∫–∞–∑—ã –∫–∞–∫ –±–æ–ª—å—à–∏–µ –∏ –º–∞–ª—ã–µ:
```sql
with tab AS (
    SELECT order_id
    FROM   courier_actions
    WHERE  action = 'accept_order'

        AND order_id not in (
            SELECT order_id
            FROM   user_actions
            WHERE  action = 'cancel_order')
)  

SELECT  order_id,
        CASE 
            WHEN array_length(product_ids, 1) > 5 THEN 'large' 
            ELSE 'small' 
        END AS order_size,
        MIN(time) as time_accepted,
        MAX(time) as time_delivered,
        DATE(MIN(time)) AS start_date,
        ROUND(extract(epoch FROM age(max(time), min(time)))::decimal / 60, 0)::INTEGER AS delivery_time
FROM   courier_actions
LEFT JOIN orders USING(order_id) 
WHERE  order_id in (SELECT order_id FROM tab)
GROUP BY order_id, product_ids
ORDER BY order_id
```
| order_id | order_size | time_accepted  | time_delivered | delivery_time |
|----------|------------|----------------|----------------|---------------|
| 1        | small      | 24/08/22 01:52 | 24/08/22 02:15 | 24            |
| 2        | small      | 24/08/22 06:37 | 24/08/22 06:56 | 18            |
| 3        | small      | 24/08/22 07:35 | 24/08/22 07:54 | 19            |
| 4        | small      | 24/08/22 10:39 | 24/08/22 10:58 | 19            |
| 5        | small      | 24/08/22 12:34 | 24/08/22 12:59 | 24            |

–ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º, –¥–æ–±–∞–≤–∏–≤ –∑–∞–ø—Ä–æ—Å:
```sql
SELECT  DATE(time_accepted) AS start_date,
        AVG(delivery_time) AS avg_delivery_time
FROM time
GROUP BY start_date
ORDER BY start_date

```
![–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ –¥–Ω—è–º](visuals/avg_delivery_time.png)

–¢–µ–ø–µ—Ä—å –ø–æ—Å—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è –æ–±–æ–∏—Ö –≥—Ä—É–ø–ø:
```sql
SELECT  PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY delivery_time) AS median,

    -- small orders
    COUNT(CASE WHEN order_size = 'small' THEN 1 END) AS orders_count_small,
    ROUND(AVG(CASE WHEN order_size = 'small' THEN delivery_time END), 2) AS mean_small,
    STDDEV(CASE WHEN order_size = 'small' THEN delivery_time END) AS std_small,
    MIN(CASE WHEN order_size = 'small' THEN delivery_time END) AS min_small,
    MAX(CASE WHEN order_size = 'small' THEN delivery_time END) AS max_small,
    
    -- large orders
    COUNT(CASE WHEN order_size = 'large' THEN 1 END) AS orders_count_large,
    ROUND(AVG(CASE WHEN order_size = 'large' THEN delivery_time END), 2) AS mean_large,
    STDDEV(CASE WHEN order_size = 'large' THEN delivery_time END) AS std_large,
    MIN(CASE WHEN order_size = 'large' THEN delivery_time END) AS min_large,
    MAX(CASE WHEN order_size = 'large' THEN delivery_time END) AS max_large
    
FROM time
```

| median | orders_count_small | mean_small | std_small          | min_small | max_small | orders_count_large | mean_large | std_large         | min_large | max_large |
|--------|--------------------|------------|--------------------|-----------|-----------|--------------------|------------|-------------------|-----------|-----------|
| 20.0   | 45690              | 19.96      | 3.03 | 5         | 32        | 10926               | 20.04      | 3.00 | 10        | 30        |

–ó–∞–º–µ—á–∞–µ–º, —á—Ç–æ –º–µ–¥–∏–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Å—Ä–µ–¥–Ω–µ–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è, –∞ —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –¥–≤—É—Ö –≥—Ä—É–ø–ø –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ. –ï—Å–ª–∏ –ø–æ—Å—Ç—Ä–æ–∏–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –º–∏–Ω—É—Ç, –∑–∞—Ç—Ä–∞—á–µ–Ω–Ω—ã—Ö –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É, –¥–ª—è –æ–±–æ–∏—Ö –≥—Ä—É–ø–ø, —Ç–æ —É–≤–∏–¥–∏–º —è–≤–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–µ __–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ__:
```sql
SELECT  delivery_time,
        COUNT(order_id) FILTER (WHERE order_size = 'large') as orders_count_large,
        COUNT(order_id) FILTER (WHERE order_size = 'small') as orders_count_small
FROM time
GROUP BY delivery_time
ORDER BY delivery_time
```

![–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ—Å—Ç–∞–≤–∫–∏](visuals/orders_count_large_small.png)

- __–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∞ –≤ SQL__

  - –ò—Ç–∞–∫, —Å—Ä–µ–¥–Ω–∏–µ –≤ –¥–≤—É—Ö –≥—Ä—É–ø–ø–∞—Ö `19.86` –∏ `20.16`, —á—Ç–æ –≤—Ä—è–¥ –ª–∏ –∏–º–µ–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é –∑–Ω–∞—á–∏–º–æ—Å—Ç—å –¥–ª—è –±–∏–∑–Ω–µ—Å–∞. –ù–æ –≤ —ç–∫—Å–ø–µ—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —É—á–µ–±–Ω—ã—Ö —Ü–µ–ª—è—Ö –ø—Ä–æ–≤–µ–¥–µ–º __z-—Ç–µ—Å—Ç__ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏ –æ—Ü–µ–Ω–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫—É—é –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫—É—é –∑–Ω–∞—á–∏–º–æ—Å—Ç—å —Ä–∞–∑–ª–∏—á–∏–π –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ SQL, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–æ—Ä–º—É–ª—ã, —á—Ç–æ –Ω–µ–æ–±—ã—á–Ω–æ, –≤–µ–¥—å —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–æ–¥—è—Ç—Å—è –æ–±—ã—á–Ω–æ —Å –ø–æ–º–æ—â—å—é Python (scipy, stats, pandas). 
  - –ü—Ä–æ–≤–æ–¥–∏–º __–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π z-—Ç–µ—Å—Ç__, –ø–æ—Å–∫–æ–ª—å–∫—É: 
    - –†–∞–∑–º–µ—Ä –≥—Ä—É–ø–ø—ã —Å "–±–æ–ª—å—à–∏–º–∏" –∑–∞–∫–∞–∑–∞–º–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç `> 10%` –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞–¥–µ–∂–Ω—ã–π —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç;
    -   –í—ã–±–æ—Ä–∫–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ;
    - –î–∞–Ω–Ω—ã–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã;
    - –û–±—ä—ë–º—ã –≤—ã–±–æ—Ä–æ–∫ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–µ (n > 30)
    - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã  –Ω–∞ –±–æ–ª—å—à–∏—Ö n –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ __t-—Ç–µ—Å—Ç–∞__, –Ω–æ –≤ —Å–ª—É—á–∞–µ __z-—Ç–µ—Å—Ç–∞__ —Ä–∞—Å—á–µ—Ç—ã –≥–æ—Ä–∞–∑–¥–æ –ø—Ä–æ—â–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ SQL.	

  - **–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –≥–∏–ø–æ—Ç–µ–∑:**
    -   **$H_0$:**  –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è –æ–±–µ–∏—Ö –≥—Ä—É–ø–ø ($avg_1 = avg_2$).
    -   **$H_1$:**  –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ —Ä–∞–∑–ª–∏—á–∞–µ—Ç—Å—è ($avg_1 \neq avg_2$).

  - **–£—Ä–æ–≤–µ–Ω—å –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ ($\alpha$)**  ‚Äî —ç—Ç–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ä–≥–Ω—É—Ç—å –Ω—É–ª–µ–≤—É—é –≥–∏–ø–æ—Ç–µ–∑—É ($H_0$), –∫–æ–≥–¥–∞ –æ–Ω–∞ –≤–µ—Ä–Ω–∞ (–æ—à–∏–±–∫–∞ I —Ä–æ–¥–∞). **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—ã–±–æ—Ä:**  $\alpha = 0.05$  (5%) ‚Üí  **95% –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª**. 

  - **–î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª**:

  $$\text{DI} = (\overline{X_1}-\overline{X_2}) \pm z_{\alpha/2} \cdot SE$$

    –≥–¥–µ $z_{\alpha/2} \approx 1.96$ - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ z-–∫—Ä–∏—Ç–µ—Ä–∏—è –¥–ª—è –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ —Ç–µ—Å—Ç–∞ —Å Œ± = 0.05 (–¥–ª—è 95% –î–ò), $SE$ - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Ä–∞–∑–Ω–∏—Ü—ã —Å—Ä–µ–¥–Ω–∏—Ö:

  $$SE = \sqrt{\frac{s_1^2}{n_1} + \frac{s_2^2}{n_2}}$$

  - **z-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**:

  $$z = \frac{\bar{X}_1 - \bar{X}_2}{SE}$$

  - **p-value**:

  $$p\text{-value} = 2 \cdot (1 - \Phi(|z|))$$

  - **–†–∞–∑–º–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞ Cohen‚Äôs d** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–µ—Ä–∞ —Ä–∞–∑–º–µ—Ä–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, **–Ω–∞—Å–∫–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏** –Ω–µ —Ç–æ–ª—å–∫–æ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –Ω–æ –∏ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏:

  $$d = \frac{\left|\overline{X_1} - \overline{X_2} \right|}{s_{\text{pooled}}}$$

    –ì–¥–µ:

  $$s_{\text{pooled}} = \sqrt{\frac{(n_1 - 1)s_1^2 + (n_2 - 1)s_2^2}{n_1 + n_2 - 2}}$$

  - –ò–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å–≤–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ñ—É–Ω–∫—Ü–∏–∏ CDF –ø—Ä–æ–≤–µ–¥–µ–º **–∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—é –ê–±—Ä–∞–º–æ–≤–∏—Ü–∞ –∏ –°—Ç–µ–≥—É–Ω–∞** –ø—Ä—è–º–æ –≤ SQL-–∑–∞–ø—Ä–æ—Å–µ –ø–æ —Ñ–æ—Ä–º—É–ª–µ:

  $$\Phi(z) \approx
  \begin{cases}
  	1 - \phi (z) \cdot \left(a_1 t + a_2 t^2 + a_3 t^3 + a_4 t^4 + a_5 t^5\right), & z \geq 0 \\
  	\phi (z) \cdot \left(a_1 t + a_2 t^2 + a_3 t^3 + a_4 t^4 + a_5 t^5\right), & z < 0
  \end{cases}$$

  - –¶–µ–ª–∏–∫–æ–º –≤–µ—Å—å –∑–∞–ø—Ä–æ—Å:

```sql
with tab AS (
    SELECT order_id
    FROM   courier_actions
    WHERE  action = 'accept_order'
        AND order_id not in (
            SELECT order_id
            FROM   user_actions
            WHERE  action = 'cancel_order')

), time AS (
    SELECT  order_id,
            CASE 
                WHEN array_length(product_ids, 1) > 5 THEN 'large' 
                ELSE 'small' 
            END AS order_size,
            MIN(time) as time_accepted,
            MAX(time) as time_delivered,
            DATE(MIN(time)) AS start_date,
            ROUND(extract(epoch FROM age(max(time), min(time)))::decimal / 60, 0)::INTEGER AS delivery_time
    FROM   courier_actions
    LEFT JOIN orders USING(order_id) 
    WHERE  order_id in (SELECT order_id FROM tab)
    GROUP BY order_id, product_ids
    ORDER BY order_id
    
), avg_vs_date AS (
    SELECT  start_date,
            AVG(delivery_time) AS avg_delivery_time
    FROM time
    GROUP BY start_date
    ORDER BY start_date

), orders_count_via_time AS (
    SELECT  delivery_time,
            COUNT(order_id) FILTER (WHERE order_size = 'large') as orders_count_large,
            COUNT(order_id) FILTER (WHERE order_size = 'small') as orders_count_small
    FROM time
    WHERE delivery_time > 4
    GROUP BY delivery_time
    ORDER BY delivery_time

), stats AS (
    SELECT  PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY delivery_time) AS median,

        -- small orders
        COUNT(CASE WHEN order_size = 'small' THEN 1 END) AS orders_count_small,
        ROUND(AVG(CASE WHEN order_size = 'small' THEN delivery_time END), 2) AS mean_small,
        STDDEV(CASE WHEN order_size = 'small' THEN delivery_time END) AS std_small,
        MIN(CASE WHEN order_size = 'small' THEN delivery_time END) AS min_small,
        MAX(CASE WHEN order_size = 'small' THEN delivery_time END) AS max_small,
        
        -- large orders
        COUNT(CASE WHEN order_size = 'large' THEN 1 END) AS orders_count_large,
        ROUND(AVG(CASE WHEN order_size = 'large' THEN delivery_time END), 2) AS mean_large,
        STDDEV(CASE WHEN order_size = 'large' THEN delivery_time END) AS std_large,
        MIN(CASE WHEN order_size = 'large' THEN delivery_time END) AS min_large,
        MAX(CASE WHEN order_size = 'large' THEN delivery_time END) AS max_large
        
    FROM time
    
), z_test AS (
    SELECT
        mean_small,
        mean_large,
        SQRT(
            (std_small^2 * orders_count_small + std_large^2 * orders_count_large)
            / (orders_count_small + orders_count_large)
        ) AS pooled_std,
        SQRT(POWER(std_small, 2)/orders_count_small + POWER(std_large, 2)/orders_count_large) AS se,
        (mean_large - mean_small) / (SQRT(POWER(std_small, 2)/orders_count_small + POWER(std_large, 2)/orders_count_large)) AS z_score,
        1 / (1 + 0.2316419 * ABS((mean_large - mean_small) / (SQRT(POWER(std_small, 2)/orders_count_small + POWER(std_large, 2)/orders_count_large)))) AS t 
    FROM stats
)

-- SELECT * FROM stats;

-- SELECT * FROM time;

SELECT
  -- –†–∞–∑–Ω–∏—Ü–∞ —Å—Ä–µ–¥–Ω–∏—Ö
  mean_large - mean_small AS mean_diff,
  
  -- Cohen‚Äôs d
  ABS(mean_large - mean_small) / pooled_std AS cohen_d,
  
  -- 95% –î–ò
  (mean_large - mean_small) - 1.96 * se AS ci_lower,
  (mean_large - mean_small) + 1.96 * se AS ci_upper,
  
  -- z-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ p-value
  z_score,
  2 * (1 - (
    CASE 
        WHEN z_score >= 0 THEN
            1 - (1 / SQRT(2 * PI())) * EXP(-(z_score^2)/2) * 
            (0.319381530 * t - 0.356563782 * t^2 + 1.781477937 * t^3 - 1.821255978 * t^4 + 1.330274429 * t^5)
        ELSE
            (1 / SQRT(2 * PI())) * EXP(-(z_score^2)/2) * 
            (0.319381530 * t - 0.356563782 * t^2 + 1.781477937 * t^3 - 1.821255978 * t^4 + 1.330274429 * t^5)
    END
    )) AS p_value
  
FROM z_test
```
- –†–µ–∑—É–ª—å—Ç–∞—Ç:

	| mean_diff | cohen_d              | ci_lower             | ci_upper            | z_score            | p_value             |
	|-----------|----------------------|----------------------|---------------------|--------------------|---------------------|
	| 0.08      | 0.026  | -0.026| 0.20 | 1.47 | 0.14 |

- –í—ã–≤–æ–¥—ã:
	- –¢–∞–∫ –∫–∞–∫  **1.48 < z_crit = 1.96**, —Ä–∞–∑–Ω–∏—Ü–∞  **–Ω–µ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏**  –Ω–∞ —É—Ä–æ–≤–Ω–µ 5%.
	- **p-value = 0.14 > 0.05** - –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∏—Ç—å —Ç–∞–∫—É—é —Ä–∞–∑–Ω–∏—Ü—É (–∏–ª–∏ –±–æ–ª—å—à–µ) –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏, –µ—Å–ª–∏ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –µ—ë –Ω–µ—Ç (–Ω—É–ª–µ–≤–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞ –≤–µ—Ä–Ω–∞), —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **14%**. ‚Üí  **–Ω–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏–π –æ—Ç–≤–µ—Ä–≥–∞—Ç—å –Ω—É–ª–µ–≤—É—é –≥–∏–ø–æ—Ç–µ–∑—É**.
	- –†–∞–∑–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ **–Ω–µ –∑–Ω–∞—á–∏–º–∞**.
	- –†–∞–∑–º–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **0.03 —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è < 0.2** - -   ‚Üí —ç—Ñ—Ñ–µ–∫—Ç  **–ø—Ä–µ–Ω–µ–±—Ä–µ–∂–∏–º–æ –º–∞–ª**. –î–∞–∂–µ –µ—Å–ª–∏ –±—ã —Ä–∞–∑–Ω–∏—Ü–∞ –±—ã–ª–∞ –∑–Ω–∞—á–∏–º–æ–π, –µ—ë  **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–º—ã—Å–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç**.

 -----------
 -----------
 
 ## 2. –ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –∏—Ö –ø—Ä–æ–¥–∞–∂
 #### 1. –í—ã—Ä—É—á–∫–∞
 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞, –≤—ã—Ä—É—á–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É, –æ–±—â—É—é –≤—ã—Ä—É—á–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `orders`, —É—á–∏—Ç—ã–≤–∞—è —Ç–æ–ª—å–∫–æ –Ω–µ–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã. –¢–∞–∫–∂–µ –æ—Ü–µ–Ω–∏—Ç—å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –º–µ–∂–¥—É: 
    - —Ü–µ–Ω–æ–π –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–æ–¥–∞–∂
    - —Ü–µ–Ω–æ–π –∏ –≤—ã—Ä—É—á–∫–æ–π
    - –∫–æ–ª–∏—á–µ—Å–≤—Ç–æ–º –ø—Ä–æ–¥–∞–∂ –∏ –≤—ã—Ä—É—á–∫–æ–π
 
     __–ó–∞–ø—Ä–æ—Å__:
```sql
SELECT  product_id,
        name,
        price,
        times_purchased,
        price * times_purchased AS product_revenue,
        SUM(price * times_purchased) OVER () AS total_revenue,
        price * times_purchased / SUM(price * times_purchased) OVER() * 100 AS revenue_percentage,
        CORR(price, times_purchased) OVER() AS price_sales_corr,
        CORR(price, price * times_purchased) OVER() AS price_revenue_corr,
        CORR(times_purchased, price * times_purchased) OVER() AS sales_revenue_corr
FROM    (
    SELECT UNNEST(product_ids) AS product_id,
           COUNT(*) AS times_purchased
    FROM   orders
    WHERE  order_id NOT IN (SELECT order_id
                            FROM   user_actions
                            WHERE  action = 'cancel_order')
    GROUP BY product_id
    ORDER BY times_purchased DESC
) t
LEFT JOIN products USING(product_id)
ORDER BY revenue_percentage DESC
```
   __–†–µ–∑—É–ª—å—Ç–∞—Ç__:
   | product_id | name            | price | times_purchased | product_revenue | total_revenue | revenue_percentage | price_sales_corr     | price_revenue_corr | sales_revenue_corr |
|------------|-----------------|-------|-----------------|-----------------|---------------|--------------------|----------------------|--------------------|--------------------|
| 57         | —Å–≤–∏–Ω–∏–Ω–∞         | 450   | 3008            | 1353600         | 21679095      | 6.24  | -0.32 | 0.64 | 0.30 |
| 77         | –∫—É—Ä–∏—Ü–∞          | 298   | 3930            | 1171140         | 21679095      | 5.40  | -0.32 | 0.64 | 0.30 |
| 15         | –º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ | 450   | 2585            | 1163250         | 21679095      | 5.36  | -0.32 | 0.64 | 0.30 |
| 66         | –≥–æ–≤—è–¥–∏–Ω–∞        | 370   | 2641            | 977170          | 21679095      | 4.51  | -0.32 | 0.64 | 0.30 |
| 37         | –±–∞—Ä–∞–Ω–∏–Ω–∞        | 559   | 1270            | 709930          | 21679095      | 3.27  | -0.32 | 0.64 | 0.30 |

- __Scatter-plots__:

  ![price-revenue](visuals/price_revenue_scatter.png)
  
 #### **1.  `price_revenue_corr = 0.64`  (–¶–µ–Ω–∞ vs –í—ã—Ä—É—á–∫–∞)**

-   **–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è**: –ß–µ–º –≤—ã—à–µ —Ü–µ–Ω–∞, —Ç–µ–º –±–æ–ª—å—à–µ –≤—ã—Ä—É—á–∫–∞.
    
-   **–°–∏–ª–∞ —Å–≤—è–∑–∏**: –°–∏–ª—å–Ω–∞—è (0.5‚Äì0.7 ‚Äî –∑–Ω–∞—á–∏–º–∞—è).
    
-   **–ü–∞—Ä–∞–¥–æ–∫—Å**: –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥–∞–∂ –ø—Ä–∏ —Ä–æ—Å—Ç–µ —Ü–µ–Ω—ã, –≤—ã—Ä—É—á–∫–∞ —Ä–∞—Å—Ç–µ—Ç. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ  **–¥–æ—Ä–æ–≥–∏–µ —Ç–æ–≤–∞—Ä—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—Ç –Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å –≤—ã—Å–æ–∫–æ–π –º–∞—Ä–∂–æ–π**.

----------

   ![sales-revenue](visuals/sales_revenue_scatter.png)

#### **2.  `sales_revenue_corr = 0.3`  (–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂ vs –í—ã—Ä—É—á–∫–∞)**

-   **–°–ª–∞–±–∞—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è**: –ë–æ–ª—å—à–µ –ø—Ä–æ–¥–∞–∂ ‚Üí —á—É—Ç—å –≤—ã—à–µ –≤—ã—Ä—É—á–∫–∞, –Ω–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞.
    
-   **–ü—Ä–∏—á–∏–Ω–∞**: –î–µ—à–µ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–æ–¥–∞—é—Ç—Å—è —á–∞—â–µ, –Ω–æ –∏—Ö –≤–∫–ª–∞–¥ –≤ –≤—ã—Ä—É—á–∫—É –º–∞–ª. –î–æ—Ä–æ–≥–∏–µ —Ç–æ–≤–∞—Ä—ã –¥–∞—é—Ç –±–æ–ª—å—à–∏–π –≤–∫–ª–∞–¥ –¥–∞–∂–µ –ø—Ä–∏ —Ä–µ–¥–∫–∏—Ö –ø—Ä–æ–¥–∞–∂–∞—Ö.

----------

   ![price-sales](visuals/price_sales_scatter.png)

   #### **3.  `price_sales_corr = -0.32`  (–¶–µ–Ω–∞ vs –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂)**

-   **–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è**: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ü–µ–Ω—ã —Å–≤—è–∑–∞–Ω–æ —Å–æ —Å–Ω–∏–∂–µ–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥–∞–∂.
    
-   **–°–∏–ª–∞ —Å–≤—è–∑–∏**: –£–º–µ—Ä–µ–Ω–Ω–∞—è (–ø–æ —à–∫–∞–ª–µ –ß–µ–¥–¥–æ–∫–∞: 0.3‚Äì0.5 ‚Äî –∑–∞–º–µ—Ç–Ω–∞—è, –Ω–æ –Ω–µ —Å–∏–ª—å–Ω–∞—è).
    
-   **–ü—Ä–∏–º–µ—Ä**: –ï—Å–ª–∏ —Ü–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ –≤—ã—Ä–∞—Å—Ç–∞–µ—Ç –Ω–∞ 10%, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∫—É–ø–æ–∫ —Å–Ω–∏–∂–∞–µ—Ç—Å—è –≤ —Å—Ä–µ–¥–Ω–µ–º –Ω–∞ ~3.2% (–ø—Ä–∏ –ø—Ä–æ—á–∏—Ö —Ä–∞–≤–Ω—ã—Ö).

----------

### **–ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã**:
1. __–û—Å–Ω–æ–≤–Ω–æ–π__: 
–ú–∞–≥–∞–∑–∏–Ω –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–∏–ª—å–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –≤—ã—Ä—É—á–∫–∏ –æ—Ç –≤—ã—Å–æ–∫–æ–º–∞—Ä–∂–∏–Ω–∞–ª—å–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤. –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å–Ω–∏–∂–µ–Ω–∏–µ —Å–ø—Ä–æ—Å–∞ –ø—Ä–∏ —Ä–æ—Å—Ç–µ —Ü–µ–Ω—ã (r = -0.32), –¥–æ—Ä–æ–≥–∏–µ —Ç–æ–≤–∞—Ä—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç 64% –≤–∞—Ä–∏–∞—Ü–∏–∏ –≤—ã—Ä—É—á–∫–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–∞–∑–≤–∏–≤–∞—Ç—å –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç, –Ω–æ –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Ä–∏—Å–∫–æ–≤.
3.  **–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç**:
    
    -   –ú–∞–≥–∞–∑–∏–Ω –ø–æ–ª—É—á–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –≤—ã—Ä—É—á–∫—É –∑–∞ —Å—á–µ—Ç  **–¥–æ—Ä–æ–≥–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤**  —Å –≤—ã—Å–æ–∫–æ–π –º–∞—Ä–∂–æ–π, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∏—Ö –Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å.
        
    -   –î–µ—à–µ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –∏–≥—Ä–∞—é—Ç —Ä–æ–ª—å "–º–∞—Å—Å–æ–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞", –Ω–æ –∏—Ö –≤–∫–ª–∞–¥ –≤ –≤—ã—Ä—É—á–∫—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.
        
4.  **–†–∏—Å–∫–∏**:
    
    -   –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –Ω–µ–±–æ–ª—å—à–æ–π –≥—Ä—É–ø–ø—ã –¥–æ—Ä–æ–≥–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤: –µ—Å–ª–∏ –∏—Ö —Å–ø—Ä–æ—Å —É–ø–∞–¥–µ—Ç, –≤—ã—Ä—É—á–∫–∞ —Ä–µ–∑–∫–æ —Å–Ω–∏–∑–∏—Ç—Å—è.
        
    -   –ù–∏–∑–∫–∞—è –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: 87 —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî –º–∞–ª–∞—è –≤—ã–±–æ—Ä–∫–∞ –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–π –º–æ–¥–µ–ª–∏.
 
-----------

#### 2. –ö–∞–∫–∏–µ –ø–∞—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–∫—É–ø–∞—é—Ç —á–∞—â–µ –≤—Å–µ–≥–æ (SELF JOIN)

```sql
-- –∫–∞–∫–∏–µ –ø–∞—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–∫—É–ø–∞—é—Ç –≤–º–µ—Å—Ç–µ —á–∞—â–µ –≤—Å–µ–≥–æ

WITH main_table AS (
    SELECT  DISTINCT order_id,
            product_id,
            name
    FROM (
        SELECT  order_id,
                unnest(product_ids) as product_id
        FROM orders
        WHERE order_id NOT IN (
            SELECT order_id
            FROM   user_actions
            WHERE  action = 'cancel_order'
        )
    ) t
    LEFT JOIN products using(product_id)
    ORDER BY order_id, name
)
    
SELECT pair,
       count(order_id) as count_pair
FROM (
    SELECT  DISTINCT a.order_id,
            CASE 
                WHEN a.name > b.name THEN string_to_array(concat(b.name, '+', a.name), '+')
                ELSE string_to_array(concat(a.name, '+', b.name), '+') 
            END AS pair
    FROM main_table a 
    JOIN main_table b
        ON a.order_id = b.order_id 
        AND a.name != b.name
) t
GROUP BY pair
ORDER BY count_pair desc, pair
```

| pair                                                    | count_pair |
|---------------------------------------------------------|------------|
| ['–∫—É—Ä–∏—Ü–∞', '—Ö–ª–µ–±']                                      | 249        |
| ['—Å–∞—Ö–∞—Ä', '—Ö–ª–µ–±']                                       | 237        |
| ['–±–∞—Ç–æ–Ω', '—Ö–ª–µ–±']                                       | 235        |
| ['–∫–æ—Ñ–µ 3 –≤ 1', '—á–∞–π —á–µ—Ä–Ω—ã–π –≤ –ø–∞–∫–µ—Ç–∏–∫–∞—Ö']                | 235        |
| ['–∫—É—Ä–∏—Ü–∞', '—Å–∞—Ö–∞—Ä']                                     | 233        |

------
-----------
 
## 3. –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### 1. –í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã

–†–∞–∑–æ–±—å–µ–º  –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã  `users`  –Ω–∞ –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã, —Å —Ü–µ–ª—å—é –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫–∞—è –≥—Ä—É–ø–ø–∞ –ª—é–¥–µ–π:
- —Å–∞–º–∞—è –º–Ω–æ–≥–æ—á–∏—Å–ª–µ–Ω–Ω–∞—è,
- –¥–µ–ª–∞–µ—Ç –Ω–∞–∏–±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤,
- –æ–±–ª–∞–¥–∞–µ—Ç –≤ —Å—Ä–µ–¥–Ω–µ–º –Ω–∞–∏–±–æ–ª–µ–µ –±–æ–ª—å—à–∏–º–∏ –∑–∞–∫–∞–∑–∞–º–∏.

 –î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –∏–∑—ä—è—Ç—å –Ω–µ–æ–±—Ö–æ–∂–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–µ –æ–±—Ö–æ–¥–∏–º–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ã `orders`, `users` –∏ `user_actions` —Å –ø–æ–º–æ—â—å—é `JOIN`. –°–ø–µ—Ä–≤–∞ –ø–æ—Å—Ç—Ä–æ–∏–º —Ç–∞–∫—É—é —Ç–∞–±–ª–∏—Ü—É, —É—á–∏—Ç—ã–≤–∞—è —Ç–æ–ª—å–∫–æ –Ω–µ–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã:

```sql
	 SELECT o.order_id, 
            ARRAY_LENGTH(o.product_ids, 1) AS order_length, 
            u.user_id, 
            coalesce(TO_CHAR(birth_date, 'DD/MM/YYYY'), 'Not specified') AS birth_date,
            case 
                when date_part('year', age('2022-12-12'::DATE, birth_date)) between 18 and 24 then '18-24'
                when date_part('year', age('2022-12-12'::DATE, birth_date)) between 25 and 29 then '25-29'
                when date_part('year', age('2022-12-12'::DATE, birth_date)) between 30 and 35 then '30-35'
                when date_part('year', age('2022-12-12'::DATE, birth_date)) >= 36 then '36+'
                else 'Not specified'
            end as group_age
            
    FROM orders o
    INNER JOIN user_actions ua 
        ON o.order_id = ua.order_id
    INNER JOIN users u
        ON ua.user_id = u.user_id
    WHERE o.order_id NOT IN (
        SELECT order_id FROM user_actions
        WHERE action = 'cancel_order'
    )
```
–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
| order_id | order_length | user_id | birth_date | group_age |
|----------|--------------|---------|------------|-----------|
| 2        | 4            | 2       | 18/06/1993 | 25-29     |
| 4        | 3            | 4       | 17/11/1991 | 30-35     |
| 6        | 5            | 6       | 05/12/1993 | 25-29     |
| 8        | 1            | 8       | 28/10/1992 | 30-35     |
| 9        | 6            | 9       | 20/07/1989 | 30-35     |

–¢–µ–ø–µ—Ä—å, –±–µ—Ä—è –≤ CTE —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É –∑–∞ –æ—Å–Ω–æ–≤—É, –º–æ–∂–µ–º —Å–¥–µ–ª–∞—Ç—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –∏ –Ω–∞–π—Ç–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–µ –Ω–∞—Å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:

```sql
WITH t1 AS (
    SELECT  o.order_id, 
            ARRAY_LENGTH(o.product_ids, 1) AS order_length, 
            u.user_id, 
            coalesce(TO_CHAR(birth_date, 'DD/MM/YYYY'), 'Not specified') AS birth_date,
            case 
                when date_part('year', age('2022-12-12'::DATE, birth_date)) between 18 and 24 then '18-24'
                when date_part('year', age('2022-12-12'::DATE, birth_date)) between 25 and 29 then '25-29'
                when date_part('year', age('2022-12-12'::DATE, birth_date)) between 30 and 35 then '30-35'
                when date_part('year', age('2022-12-12'::DATE, birth_date)) >= 36 then '36+'
                else 'Not specified'
            end as group_age
            
    FROM orders o
    INNER JOIN user_actions ua 
        ON o.order_id = ua.order_id
    INNER JOIN users u
        ON ua.user_id = u.user_id
    WHERE o.order_id NOT IN (
        SELECT order_id FROM user_actions
        WHERE action = 'cancel_order'
    )
)

SELECT  group_age, 
        COUNT(DISTINCT user_id) AS users_count,
        COUNT(order_id) AS orders_count,
        SUM(COUNT(DISTINCT user_id)) OVER()::INTEGER AS total_users_count,
        SUM(COUNT(order_id)) OVER()::INTEGER AS total_orders_count, 
        ROUND(AVG(order_length), 2) AS avg_orders_len

FROM t1
GROUP BY group_age
ORDER BY group_age
```
–†–µ–∑—É–ª—å—Ç–∞—Ç:
| group_age     | users_count | orders_count | total_users_count | total_orders_count | avg_orders_len |
|---------------|-------------|--------------|-------------------|--------------------|----------------|
| 18-24         | 516         | 1350         | 20034             | 53670              | 3.44           |
| 25-29         | 8821        | 23771        | 20034             | 53670              | 3.39           |
| 30-35         | 10306       | 27542        | 20034             | 53670              | 3.41           |
| 36+           | 341         | 873          | 20034             | 53670              | 3.41           |
| Not specified | 50          | 134          | 20034             | 53670              | 3.29           |

![–í–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –≥—Ä—É–ø–ø—ã](visuals/pie_age_groups.png)

**–í—ã–≤–æ–¥**:

–ù–∞–∏–±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π, –ø–æ–ª—å–∑—É—é—â–∏—Ö—Å—è —É—Å–ª—É–≥–∞–º–∏ —Å–µ—Ä–≤–∏—Å–∞, –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –≤–æ–∑—Ä–∞—Å—Ç–µ 25-35 –ª–µ—Ç –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–∏—Å–µ (~ 95%). –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∑–∞–∫–∞–∑–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã—Ö –≥—Ä—É–ø–ø.

---

#### 2. C—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∑–∞–∫–∞–∑–∞ –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º –∏ –±—É–¥–Ω—è–º
–ü–æ –¥–∞–Ω–Ω—ã–º –∏–∑ —Ç–∞–±–ª–∏—Ü—ã  `orders`  —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º  —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∑–∞–∫–∞–∑–∞ –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º –∏ –±—É–¥–Ω—è–º, –∏ –æ–ø—Ä–µ–¥–µ–ª–∏–º —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –∑–Ω–∞—á–∏–º–æ–π.

```sql
SELECT case when to_char(creation_time, 'Dy') in ('Sat', 'Sun') then 'weekend'
            else 'weekdays' end as week_part,
       round(avg(array_length(product_ids, 1)), 2) as avg_order_size
FROM   orders
GROUP BY week_part
ORDER BY avg_order_size asc
```
| week_part | avg_order_size |
|-----------|----------------|
| weekend   | 3.39           |
| weekdays  | 3.4            |

–†–∞–∑–Ω–∏—Ü–∞ –Ω–µ–∑–Ω–∞—á–∏–º–∞.

#### 3. –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏. 

**–∞)** –°–ø–µ—Ä–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `user_actions`  –ø–æ—Å—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∏ –¥–æ–ª—é –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤. 

```sql
SELECT  user_id,
            COUNT(DISTINCT order_id) FILTER (WHERE action = 'cancel_order') AS cancel_orders,
            COUNT(DISTINCT order_id) AS orders_count,
            ROUND(COUNT(DISTINCT order_id) FILTER (WHERE action = 'cancel_order')::DECIMAL / COUNT(DISTINCT order_id), 2) AS cancel_rate
    FROM user_actions
    GROUP BY user_id
```
–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
| user_id | cancel_orders | orders_count | cancel_rate |
|---------|---------------|--------------|-------------|
| 1       | 0             | 4            | 0.0         |
| 2       | 0             | 2            | 0.0         |
| 3       | 0             | 4            | 0.0         |
| 4       | 0             | 2            | 0.0         |
| 5       | 0             | 1            | 0.0         |

–°–≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤, –∏ –Ω–∞–π–¥–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ —Å —Ç–∞–∫–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—Ç–º–µ–Ω—ã, –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ–≤–µ—Ä—à–∏–≤—à–∏—Ö —Å—Ç–æ–ª—å–∫–æ –æ—Ç–º–µ–Ω, –∞ —Ç–∞–∫–∂–µ –æ—Ç—ã—â–µ–º —Å—Ä–µ–¥–Ω–µ–µ –ø–æ `cancel_rate`:

```sql
WITH t1 AS (
    SELECT  user_id,
            COUNT(DISTINCT order_id) FILTER (WHERE action = 'cancel_order') AS cancel_orders,
            COUNT(DISTINCT order_id) AS orders_count,
            ROUND(COUNT(DISTINCT order_id) FILTER (WHERE action = 'cancel_order')::DECIMAL / COUNT(DISTINCT order_id), 2) AS cancel_rate,
            SUM(COUNT(DISTINCT order_id)) OVER() AS total_orders,
            SUM(COUNT(DISTINCT order_id) FILTER (WHERE action = 'cancel_order')) OVER() AS total_cancels
    FROM user_actions
    GROUP BY user_id
)

SELECT  cancel_orders,
        SUM(orders_count)::INTEGER AS sum_orders_count,
        COUNT(user_id) AS users,
        ROUND(AVG(cancel_rate), 2) AS avg_cancel_rate,
        -- (SELECT SUM(cancel_rate) / COUNT(user_id) FROM t1) AS avg_cancel_rate_total,
        -- –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ: –æ–±—â–∏–µ –æ—Ç–º–µ–Ω—ã / –æ–±—â–∏–µ –∑–∞–∫–∞–∑—ã
        ROUND(total_cancels::DECIMAL / total_orders, 2) AS avg_cancel_rate_total
FROM t1
GROUP BY cancel_orders, total_orders, total_cancels
ORDER BY cancel_orders ASC
```

| cancel_orders | sum_orders_count | users | avg_cancel_rate | avg_cancel_rate_total |
|---------------|------------------|-------|-----------------|-----------------------|
| 0             | 48813            | 18641 | 0.0             | 0.05                  |
| 1             | 9639             | 2555  | 0.38            | 0.05                  |
| 2             | 1044             | 191   | 0.43            | 0.05                  |
| 3             | 99               | 14    | 0.49            | 0.05                  |

![–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤](visuals/cancel_rate.png)

**–±)** –¢–µ–ø–µ—Ä—å –ø–æ—Å–º–æ—Ç—Ä–∏–º, –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –ª–∏  success rate  (–¥–æ–ª—è –Ω–µ–æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤) –∏ —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∏ –Ω–µ–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–∑–Ω—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏:

```sql
SELECT  
        date_part('isodow', time)::int as weekday_number,
        to_char(time, 'Dy') as weekday,
        count(ua.order_id) filter (WHERE action = 'create_order') as created_orders,
        count(ua.order_id) filter (WHERE action = 'cancel_order') as canceled_orders,
        count(ua.order_id) filter (WHERE action = 'create_order') 
            - count(ua.order_id) filter (WHERE action = 'cancel_order') as actual_orders,
        round((count(ua.order_id) filter (WHERE action = 'create_order') 
            - count(ua.order_id) filter (WHERE action = 'cancel_order'))::decimal / 
            count(ua.order_id) filter (WHERE action = 'create_order'), 3) as success_rate,
        AVG(array_length(o.product_ids, 1)) FILTER (WHERE action = 'create_order') 
            AS avg_order_size,
        AVG(array_length(o.product_ids, 1)) FILTER (WHERE action = 'cancel_order') 
            AS avg_cancelled_order_size
            
FROM   user_actions ua
INNER JOIN orders o
    ON ua.order_id = o.order_id
WHERE  time >= '2022-08-24'
  and time < '2022-09-07'
GROUP BY weekday_number, weekday
ORDER BY weekday_number
```

| weekday_number | weekday | created_orders | canceled_orders | actual_orders | success_rate | avg_order_size | avg_cancelled_order_size |
|----------------|---------|----------------|-----------------|---------------|--------------|----------------|--------------------------|
| 1              | Mon     | 8374           | 434             | 7940          | 0.948        | 3.41           | 3.43                     |
| 2              | Tue     | 7193           | 370             | 6823          | 0.949        | 3.40           | 3.42                     |
| 3              | Wed     | 3758           | 210             | 3548          | 0.944        | 3.39           | 3.47                     |
| 4              | Thu     | 5004           | 258             | 4746          | 0.948        | 3.41           | 3.30                     |
| 5              | Fri     | 6800           | 352             | 6448          | 0.948        | 3.39           | 3.34                     |
| 6              | Sat     | 8249           | 399             | 7850          | 0.952        | 3.40           | 3.46                     |
| 7              | Sun     | 9454           | 443             | 9011          | 0.953        | 3.37           | 3.35                     |

![–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏](visuals/orders_per_day_of_week.png)

![–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∏ –Ω–µ–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏](visuals/avg_order_size_per_weekday.png)

**–í—ã–≤–æ–¥:**

- –î–æ–ª—è –Ω–µ–æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (`success_rate`) –∏ —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∏ –Ω–µ–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–∑–Ω—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ —É—Ä–æ–≤–Ω–µ, –∞–Ω–æ–º–∞–ª–∏–π –Ω–µ—Ç, —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ. 
- –ó–∞–º–µ—Ç–Ω–æ –º–µ–Ω—å—à–µ –∑–∞–∫–∞–∑–æ–≤ —Å–æ–≤–µ—Ä—à–∞–µ—Ç—Å—è –≤ –ø–æ —Å—Ä–µ–¥–∞–º –∏ —á–µ—Ç–≤–µ—Ä–≥–∞–º, —á–∞—â–µ - –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ –Ω–µ–¥–µ–ª–∏.

#### 4. –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (–ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –ø–æ –∑–∞–∫–∞–∑–∞–º)

**–∞)** –î–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–∏–º —Ç–∞–±–ª–∏—Ü—É, –≤ –∫–æ—Ç–æ—Ä–æ–π —Ä–∞—Å—Å—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞, —Å–æ–≤—Ä—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏. –î–ª—è —ç—Ç–æ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–Ω–∞—á–∞–ª–∞ "—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å" —Ç–∞–±–ª–∏—Ü—É `orders` –ø–æ —Å—Ç–æ–ª–±—Ü—É `product_ids`, –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å –ø–æ–º–æ—â—å—é `LEFT JOIN` —ç—Ç—É —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é —Ç–∞–±–ª–∏—Ü—É —Å —Ç–∞–±–ª–∏—Ü–µ–π `products`, `user_actions` –∏ `users`:

```sql
-- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫

SELECT  o.order_id,
        u.user_id,
        ARRAY_AGG(p.name) AS product_names,
        ARRAY_LENGTH(o.product_ids, 1) AS order_size,
        SUM(p.price) AS order_price
FROM (
    SELECT order_id, product_ids, unnest(product_ids) AS product_id
    FROM orders
    WHERE order_id NOT IN (
        SELECT order_id FROM user_actions
        WHERE action = 'cancel_order'
    )
) o
LEFT JOIN products p
    ON o.product_id = p.product_id
LEFT JOIN user_actions ua
    ON o.order_id = ua.order_id
LEFT JOIN users u
    ON ua.user_id = u.user_id
GROUP BY o.order_id, o.product_ids, u.user_id
ORDER BY order_price DESC

```

| order_id | user_id | order_price | order_size | product_names                                                                                |
|----------|---------|-------------|------------|----------------------------------------------------------------------------------------------|
| 59374    | 16710   | 2014.00     | 6          | ['—Å–≤–∏–Ω–∏–Ω–∞', '–ª–∏–º–æ–Ω–∞–¥', '—á–∞–π —á–µ—Ä–Ω—ã–π –ª–∏—Å—Ç–æ–≤–æ–π', '–∫–æ—Ñ–µ –±–µ–∑ –∫–æ—Ñ–µ–∏–Ω–∞', '–∏–∫—Ä–∞', '–º–æ—Ä—Å –±—Ä—É—Å–Ω–∏—á–Ω—ã–π'] |
| 44230    | 10951   | 2006.00     | 6          | ['–∫–µ—Ç—á—É–ø', '–∫—É—Ä–∏—Ü–∞', '–∏–∫—Ä–∞', '–º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ', '—Å—É—à–∫–∏', '–≥–æ–≤—è–¥–∏–Ω–∞']                         |
| 55638    | 20373   | 1959.00     | 6          | ['–≥–æ–≤—è–¥–∏–Ω–∞', '—Å–≤–∏–Ω–∏–Ω–∞', '–±–∞—Ä–∞–Ω–∏–Ω–∞', '–≤–æ–¥–∞ –Ω–µ–≥–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è', '–º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ', '—Å–º–µ—Ç–∞–Ω–∞']     |
| 33395    | 13807   | 1959.00     | 6          | ['–∫—É—Ä–∏—Ü–∞', '–∏–∫—Ä–∞', '—Ä–∏—Å', '—à–æ–∫–æ–ª–∞–¥ —á–µ—Ä–Ω—ã–π', '–∫–æ—Ñ–µ –∑–µ—Ä–Ω–æ–≤–æ–π', '–º–µ–¥']                          |
| 56492    | 13599   | 1946.00     | 5          | ['–∏–∫—Ä–∞', '—Å–æ—Å–∏—Å–∫–∏', '–∫–æ—Ñ–µ —Ä–∞—Å—Ç–≤–æ—Ä–∏–º—ã–π', '–ª–µ–¥–µ–Ω—Ü—ã', '–∏–∫—Ä–∞']                                   |

**–±)** –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ —É–∑–Ω–∞–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ –Ω–∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤, –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ –∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ –∫—É–ø–ª–µ–Ω–æ –≤–æ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–∞—Ö (`t1` - –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞):

```sql
SELECT  user_id,
        COUNT(order_id) AS total_orders,
        SUM(order_price) AS total_price,
        SUM(order_size) AS total_products
FROM t1
GROUP BY user_id
ORDER BY total_price DESC, total_orders DESC, user_id ASC
LIMIT 5
``` 

| user_id | total_orders | total_price | total_products |
|---------|--------------|-------------|----------------|
| 3131    | 11           | 6490        | 45             |
| 2567    | 8            | 6296        | 36             |
| 3793    | 17           | 6225        | 58             |
| 451     | 9            | 5890        | 32             |
| 183     | 10           | 5880        | 47             |

–≠—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª–µ–∑–Ω–∞, –µ—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏–º –ø–æ–æ—â—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º –¥–ª—è —Å–∞–º—ã—Ö –ø–ª–∞—Ç–µ–∂–µ—Å–ø–æ—Å–æ–±–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å–µ—Ä–≤–∏—Å–∞,

**–≤)** –¢–µ–ø–µ—Ä—å –Ω–∞–π–¥–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —ç—Ç–∏–º —Å—Ç–æ–ª–±—Ü–∞–º

```sql
-- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (–ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)

WITH t1 AS (
    SELECT  o.order_id,
            u.user_id,
            SUM(p.price) AS order_price,
            ARRAY_LENGTH(o.product_ids, 1) AS order_size,
            ARRAY_AGG(p.name) AS product_names
    FROM (
        SELECT order_id, product_ids, unnest(product_ids) AS product_id
        FROM orders
        WHERE order_id NOT IN (
            SELECT order_id FROM user_actions
            WHERE action = 'cancel_order'
        )
    ) o
    LEFT JOIN products p
        ON o.product_id = p.product_id
    LEFT JOIN user_actions ua
        ON o.order_id = ua.order_id
    INNER JOIN users u
        ON ua.user_id = u.user_id
    GROUP BY o.order_id, o.product_ids, u.user_id
    ORDER BY order_price DESC
    
), t2 AS (
    SELECT  user_id,
            COUNT(order_id) AS total_orders,
            SUM(order_price) AS total_price,
            SUM(order_size) AS total_products
    FROM t1
    GROUP BY user_id
    ORDER BY total_price DESC, total_orders DESC, user_id ASC
)

SELECT

    AVG(total_orders) AS avg_total_orders,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY total_orders) AS median_orders,
    MIN(total_orders) AS min_total_orders,
    MAX(total_orders) AS max_total_orders,
    
    AVG(total_price) AS avg_total_price,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY total_price) AS median_price,
    MIN(total_price) AS min_total_price,
    MAX(total_price) AS max_total_price
    
FROM t2

```

| avg_total_orders   | median_orders | min_total_orders | max_total_orders | avg_total_price    | median_price | min_total_price | max_total_price |
|--------------------|---------------|------------------|------------------|--------------------|--------------|-----------------|-----------------|
| 2.68 | 2.0           | 1                | 17               | 1026.46 | 828.0        | 1               | 6490            |

```sql
    -- —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ "–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π" –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ö–æ–¥–Ω–æ–π t1
    SELECT
        
        AVG(order_price) AS avg_total_price,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY order_price) AS median_price,
        MIN(order_price) AS min_total_price,
        MAX(order_price) AS max_total_price
        
    FROM t1
```

| avg_total_price   | median_price | min_total_price | max_total_price |
|-------------------|--------------|-----------------|-----------------|
| 383.16 | 321.0        | 1.0               | 2014.0            |


**–í—ã–≤–æ–¥:**
  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å—Ä–µ–¥–Ω–µ–º —Ç—Ä–∞—Ç–∏—Ç - 1026, –ø—Ä–∏ –º–∞–∫—Å–∏–º—É–º–µ - 6490 –∏ –º–µ–¥–∏–∞–Ω–µ 828. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–¥–µ–ª–∞–ª–∏ –ø–æ 2-3 –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–µ—Ä–≤–∏—Å–µ. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–µ—Å—Å–∏–º–µ—Ç—Ä–∏—á–Ω—ã - –ø—Ä–∏–∑–Ω–∞–∫ –Ω–µ–Ω–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏. –°–∞–º—ã—Ö –ø–ª–∞—Ç–µ–∂–µ—Å–ø–æ—Å–æ–±–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –º–æ–∂–Ω–æ –ø–æ–æ—â—Ä–∏—Ç—å –±–∞–ª–ª–∞–º–∏ –∏–ª–∏ –ø–æ–¥–∞—Ä–∫–∞–º–∏, –¥–∞—Ç—å –ø—Ä–∏–≤–µ–ª–µ–≥–∏–∏, —á—Ç–æ–±—ã –∑–∞–º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∞—Ç—å –µ—â–µ.
  - –° –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ –≤ —Å—Ä–µ–¥–Ω–µ–º —Å–µ—Ä–≤–∏—Å –ø–æ–ª—É–µ—Ç ~ 380 —Ä. 

#### 5. –ö—Ç–æ –æ—Ñ–æ—Ä–º–ª—è–ª –∏ –¥–æ—Å—Ç–∞–≤–ª—è–ª —Å–∞–º—ã–µ –±–æ–ª—å—à–∏–µ –∑–∞–∫–∞–∑—ã
```sql
-- –ö–¢–æ –æ—Ñ–æ—Ä–º–ª—è–ª –∏ –¥–æ—Å—Ç–∞–≤–ª—è–ª —Å–∞–º—ã–µ –±–æ–ª—å—à–∏–µ –∑–∞–∫–∞–∑—ã

WITH last_date as (
    SELECT time::date
    FROM user_actions
    ORDER BY time desc limit 1

), uo as (
    SELECT order_id,
           user_id
    FROM user_actions
    WHERE action = 'create_order'
        AND order_id NOT IN (
            SELECT order_id
            FROM   user_actions
            WHERE  action = 'cancel_order'
        )
)

SELECT DISTINCT order_id,
        user_id,
        date_part('year', age((SELECT * FROM last_date), u.birth_date))::integer as user_age,
        courier_id, 
        date_part('year', age((SELECT * FROM   last_date), c.birth_date))::integer as courier_age
        
FROM uo
    LEFT JOIN orders o using(order_id)
    LEFT JOIN courier_actions ca using(order_id)
    LEFT JOIN users u using(user_id)
    LEFT JOIN couriers c using(courier_id)
WHERE  array_length(product_ids, 1) = (SELECT max(array_length(product_ids, 1)) FROM   orders)
ORDER BY order_id
```

| order_id | user_id | user_age | courier_id | courier_age |
|----------|---------|----------|------------|-------------|
| 7949     | 3804    | 29       | 845        | 19          |
| 18853    | 5433    | 31       | 1537       | 33          |
| 29786    | 12728   | 33       | 431        | 26          |
| 49755    | 18622   | 29       | 1619       | 32          |
| 51414    | 17170   | 31       | 2564       | 27          |

-----------
-----------

## 4. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –±–∏–∑–Ω–µ—Å-–ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π 
